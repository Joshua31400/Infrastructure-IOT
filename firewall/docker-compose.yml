version: '3.8'

services:
  firewall:
    image: alpine:latest
    container_name: firewall
    hostname: firewall
    command: |
      sh -c "
      apk add --no-cache iptables tcpdump curl bash jq
      
      sysctl -w net.ipv4.ip_forward=1
      
      iptables -F
      iptables -X
      iptables -t nat -F
      iptables -t nat -X
      
      iptables -P INPUT DROP
      iptables -P FORWARD DROP
      iptables -P OUTPUT ACCEPT
      
      iptables -A INPUT -i lo -j ACCEPT
      iptables -A OUTPUT -o lo -j ACCEPT
      
      iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
      iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
      
      iptables -A FORWARD -s 192.168.10.0/24 -d 10.0.0.0/24 -p tcp --dport 8883 -j LOG --log-prefix '[FW-IOT-MQTT] ' --log-level 6
      iptables -A FORWARD -s 192.168.10.0/24 -d 10.0.0.0/24 -p tcp --dport 8883 -j ACCEPT
      
      iptables -A FORWARD -s 192.168.20.0/24 -d 10.0.0.0/24 -p tcp -m multiport --dports 22,443,3000,8086 -j LOG --log-prefix '[FW-ADMIN-DMZ] ' --log-level 6
      iptables -A FORWARD -s 192.168.20.0/24 -d 10.0.0.0/24 -p tcp -m multiport --dports 22,443,3000,8086 -j ACCEPT
      
      iptables -A FORWARD -s 192.168.30.0/24 -d 10.0.0.0/24 -p tcp --dport 443 -j LOG --log-prefix '[FW-BUREAU-DMZ] ' --log-level 6
      iptables -A FORWARD -s 192.168.30.0/24 -d 10.0.0.0/24 -p tcp --dport 443 -j ACCEPT
      
      iptables -A FORWARD -s 192.168.30.0/24 -d 10.0.0.30 -p tcp --dport 3000 -j LOG --log-prefix '[FW-BUREAU-GRAFANA] ' --log-level 6
      iptables -A FORWARD -s 192.168.30.0/24 -d 10.0.0.30 -p tcp --dport 3000 -j ACCEPT
      
      iptables -A FORWARD -s 10.0.0.0/24 -o eth0 -j LOG --log-prefix '[FW-DMZ-WAN] ' --log-level 6
      iptables -A FORWARD -s 10.0.0.0/24 -o eth0 -j ACCEPT
      
      iptables -A FORWARD -s 10.0.0.0/24 -d 10.0.0.0/24 -j ACCEPT
      
      iptables -A FORWARD -j LOG --log-prefix '[FW-BLOCKED] ' --log-level 4
      
      iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      
      echo 'Firewall configure!'
      iptables -L FORWARD -n -v
      
      echo 'Demarrage Firewall Logger...'
      chmod +x /firewall-logger.sh
      /firewall-logger.sh &
      
      tail -f /dev/null
      "
    cap_add:
      - NET_ADMIN
    networks:
      zone-a-iot:
        ipv4_address: 192.168.10.254
      zone-b-admin:
        ipv4_address: 192.168.20.254
      zone-c-bureautique:
        ipv4_address: 192.168.30.254
      zone-d-dmz:
        ipv4_address: 10.0.0.254
    volumes:
      - ./firewall-logger.sh:/firewall-logger.sh:ro
    restart: unless-stopped

networks:
  zone-a-iot:
    name: zone-a-iot
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.10.0/24
          gateway: 192.168.10.1
  zone-b-admin:
    name: zone-b-admin
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.20.0/24
          gateway: 192.168.20.1
  zone-c-bureautique:
    name: zone-c-bureautique
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.30.0/24
          gateway: 192.168.30.1
  zone-d-dmz:
    name: zone-d-dmz
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/24
          gateway: 10.0.0.1